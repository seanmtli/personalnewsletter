{% extends "base.html" %}

{% block title %}Newsletter - SportsPulse{% endblock %}

{% block content %}
<div>
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold">Newsletter #{{ newsletter.id }}</h1>
            <p class="text-muted text-sm mt-1">
                Generated {{ newsletter.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                <span class="badge-neutral ml-2">{{ newsletter.provider_used }}</span>
            </p>
        </div>
        <div class="flex gap-3">
            {% if not newsletter.sent_at %}
            <button onclick="sendNewsletter({{ newsletter.id }})" class="btn-primary">
                Send to Email
            </button>
            {% else %}
            <span class="badge-success py-2 px-4">
                Sent {{ newsletter.sent_at.strftime('%b %d, %Y') }}
            </span>
            {% endif %}
            <a href="/newsletter/archive" class="btn-ghost">
                Back to Archive
            </a>
        </div>
    </div>

    {% if newsletter.interests_used %}
    <div class="mb-6">
        <span class="text-sm text-muted">Interests searched:</span>
        <div class="flex flex-wrap gap-2 mt-2">
            {% for interest in newsletter.interests_used %}
            <span class="chip-dark">
                {{ interest }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Newsletter Content -->
    <div class="card-dark p-6">
        {% if newsletter.content_json and newsletter.content_json.get('items') %}
        <div class="divide-y divide-white/5">
            {% for item in newsletter.content_json.get('items', []) %}
            <article class="article-card">
                <div class="flex gap-4">
                    {% if item.thumbnail_url %}
                    <div class="flex-shrink-0">
                        <img src="{{ item.thumbnail_url }}" alt=""
                            class="w-24 h-24 object-cover rounded-lg">
                    </div>
                    {% endif %}
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold mb-2">
                            <a href="{{ item.url }}" target="_blank" rel="noopener"
                                class="article-title hover:text-orange-400 transition-colors">
                                {{ item.headline }}
                            </a>
                        </h3>
                        <p class="article-summary mb-3">{{ item.summary }}</p>
                        <div class="flex items-center article-meta gap-4">
                            <span class="inline-flex items-center">
                                {% if item.source_type == 'article' %}ğŸ“°
                                {% elif item.source_type == 'tweet' %}ğŸ¦
                                {% elif item.source_type == 'video' %}ğŸ¬
                                {% elif item.source_type == 'reddit' %}ğŸ’¬
                                {% endif %}
                                <span class="ml-1">{{ item.source_name }}</span>
                            </span>
                            {% if item.published_at %}
                            <span>{{ item.published_at[:10] if item.published_at is string else item.published_at }}</span>
                            {% endif %}
                        </div>
                        {% if item.relevance %}
                        <p class="text-sm text-orange-400 mt-2">{{ item.relevance }}</p>
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <!-- Fallback to raw HTML content -->
        <div class="newsletter-content">
            {{ newsletter.content | safe }}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function sendNewsletter(id) {
    if (!confirm('Send this newsletter to your email?')) return;

    try {
        const response = await fetch('/newsletter/send/' + id, {
            method: 'POST',
        });

        const data = await response.json();

        if (response.ok) {
            alert('Newsletter sent to ' + data.email);
            window.location.reload();
        } else {
            alert('Error: ' + (data.detail || 'Failed to send'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
